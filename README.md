<div dir="rtl">

# معماری سرویس‌های پایه برای استارت هر پروژه

این سند توضیح می‌دهد چه مایکروسرویس‌هایی را باید یک‌بار بسازی و بعد در هر پروژهٔ جدید از آن‌ها استفاده مجدد کنی.  
هدف: حرکت مثل یک CTO ـی حرفه‌ای، بدون اینکه هر بار از صفر شروع کنی.

ترتیب مستند:
- چرا این سرویس لازم است
- چه داده‌ای صاحب آن است
- چه قابلیت‌هایی باید داشته باشد تا قابل استفادهٔ مجدد باشد
- چه زمانی بسازیم / جدا کنیم

---

## ۱. سرویس احراز هویت (Auth / Identity Service)

### ماموریت سرویس
مرکز لاگین، ثبت‌نام، توکن و مدیریت نشست‌ها.  
هیچ سرویس دیگری نباید با رمز عبور مستقیم درگیر شود.

### داده‌هایی که مالک آن است
- `users`: ایمیل، هش رمز عبور، وضعیت فعال/مسدود، زمان ساخت
- `sessions`: رفرش‌توکن، زمان انقضا
- نقش‌ها و سطح دسترسی پایه (RBAC ساده مثل `admin`, `user`)

### قابلیت‌های ضروری
- ثبت‌نام با ایمیل/رمز
- لاگین
- فراموشی رمز / لینک بازیابی
- صدور `access_token` (JWT) و `refresh_token`
- logout (باطل‌کردن رفرش‌توکن)
- بررسی فعال بودن کاربر (`is_banned`, `is_active`)
- آخرین ورود (last_login)

### امکانات حرفه‌ای (بعداً)
- لاگین با گوگل/گیت‌هاب (OAuth)
- سازمان/تیم (multi-tenant): یک کاربر در چند workspace با نقش متفاوت
- صدور API Key برای استفادهٔ برنامه‌نویسی

---

## ۲. سرویس پروفایل کاربر (User Profile / Account Service)

### ماموریت سرویس
مدیریت اطلاعات نمایشی و تنظیمات کاربر که امنیتی نیستند.  
این داده‌ها نباید داخل سرویس احراز هویت شلوغ شوند.

### داده‌هایی که مالک آن است
- نام قابل نمایش، بیو، آواتار
- منطقه زمانی، زبان
- تنظیمات نوتیفیکیشن
- تلفن، آدرس صورتحساب (در صورت نیاز)

### قابلیت‌های ضروری
- CRUD پروفایل
- آپلود یا تغییر آواتار (فقط نگهداری شناسه فایل، نه خود فایل)
- گرفتن پروفایل کاربر لاگین‌شده بر اساس `user_id`

---

## ۳. سرویس دسترسی و مجوزها (Permissions / Access Control Service)

> نکته: در MVP می‌تونی این رو با Auth یکی نگه داری.  
> وقتی محصولت جدی شد (سازمانی، اشتراک فایل، سطح دسترسی ریز)، جداش کن.

### ماموریت سرویس
به صورت متمرکز جواب بدهد:
«آیا کاربر X اجازه انجام عمل Y روی منبع Z را دارد؟»

### داده‌هایی که مالک آن است
- نقش‌ها (role)
- سیاست‌ها / قوانین دسترسی
- مالکیت منابع (چه کسی صاحب پروژه/سازمان است)

### قابلیت‌های ضروری
- تعریف نقش‌ها (مثلاً `owner`, `admin`, `editor`, `viewer`)
- API بررسی دسترسی:
  - ورودی: `user_id`, `action`, `resource`
  - خروجی: `allow | deny`
- مدیریت نقش اعضای یک سازمان/تیم

---

## ۴. سرویس نوتیفیکیشن (Notification Service)

### ماموریت سرویس
ارسال پیام به کاربرها، بدون اینکه سرویس‌های دیگر بدانند ایمیل چطور ارسال می‌شود یا پوش‌نوتیفیکیشن چطور کار می‌کند.

### داده‌هایی که مالک آن است
- صف ایمیل / پیام
- تاریخچه ارسال (چه چیزی چه زمانی برای چه کسی ارسال شد)
- توکن پوش موبایل
- قالب‌های پیام (template)

### قابلیت‌های ضروری
- ارسال ایمیل ترنزکشنال (Welcome, Reset Password, Invite, ...)
- ارسال نوتیفیکیشن داخل برنامه (in-app notification / badge)
- مارک کردن نوتیفیکیشن به عنوان «خوانده شد»
- ریترای در صورت شکست ارسال

### چرا جداست؟
- هر سرویس دیگری می‌تواند فقط یک رویداد منتشر کند (مثلاً `INVOICE_PAID`)
- سرویس نوتیفیکیشن تصمیم می‌گیرد به چه کانالی پیام برود
- می‌توانی راحت Provider رو عوض کنی (SendGrid → SES و ...)

---

## ۵. سرویس فایل / رسانه (File / Media Service)

### ماموریت سرویس
آپلود و مدیریت فایل‌ها (عکس پروفایل، ضمیمه‌ها، PDF فاکتور، تصویر محصول و ...).

### داده‌هایی که مالک آن است
- `files`: شناسه فایل، صاحب فایل (`owner_user_id` / `org_id`)، مسیر ذخیره، MIME type، اندازه، حالت دسترسی (عمومی/خصوصی)
- URL امضا شده جهت دانلود موقت

### قابلیت‌های ضروری
- آپلود فایل → برگشت `file_id` و URL
- ساخت لینک دانلود امن برای فایل‌های خصوصی (signed URL با انقضا)
- نگهداری این‌که چه کسی اجازه دیدن فایل دارد

### امکانات حرفه‌ای
- ساخت thumbnail / تغییر سایز تصویر
- اسکن امنیتی/آنتی‌ویروس

### چرا جداست؟
همه‌ی سرویس‌ها به فایل نیاز دارند. اگر آپلود داخل هر سرویس باشد، کد تکرار و دردسر ماژولار کردن خیلی زیاد می‌شود.

---

## ۶. سرویس لاگ فعالیت / ممیزی (Audit / Activity Log Service)

### ماموریت سرویس
ثبت این‌که «چه کسی، چه کاری، چه زمانی انجام داد؟»

این سرویس هم برای امنیت لازم است، هم برای UI («آخرین فعالیت‌ها»)، هم برای ساپورت/دیباگ.

### داده‌هایی که مالک آن است
- رویدادهای غیرقابل‌تغییر از جنس:
  - کاربر ۱۲۳ پروژه ۷۸۹ را ساخت
  - کاربر ۱۲۳ نقش کاربر ۴۵۶ را به ادمین تغییر داد
  - IP و مرورگر در صورت نیاز امنیتی

### قابلیت‌های ضروری
- API برای نوشتن رویداد
- API برای کوئری بر اساس کاربر / سازمان / منبع

### چرا جداست؟
- برای بازرسی امنیتی
- برای پاسخ به سوال «چه کسی اینو حذف کرد؟»
- برای صفحه Activity Feed در پنل ادمین

---

## ۷. سرویس صورتحساب و پرداخت (Billing / Payments Service)

### ماموریت سرویس
مدیریت پول، پلن‌ها، سقف استفاده و اشتراک‌ها.

### داده‌هایی که مالک آن است
- سازمان‌ها / تیم‌ها (orgs)
- اشتراک‌ها، وضعیت پلن، تاریخ تمدید
- فاکتورها / رسیدها
- شناسه مشتری در درگاه پرداخت (Stripe customer_id و غیره)

### قابلیت‌های ضروری
- ایجاد مشتری جدید هنگام ساخت سازمان
- شروع / لغو اشتراک
- دریافت Webhook از درگاه پرداخت (پرداخت موفق / ناموفق)
- پاسخ به این سؤال برای سرویس‌های دیگر:
  - «آیا این سازمان اجازه دسترسی به این قابلیت را دارد؟»
  - «آیا محدودیت ظرفیتش پر شده؟»

### چرا جداست؟
- نمی‌خواهی منطق مالی داخل دامنه اصلی (پروژه، تسک، چت و...) قاطی شود
- در آینده می‌توانی چند محصول مختلف داشته باشی و همه‌شان را با یک سرویس Billing شارژ کنی

---

## ۸. سرویس آنالیتیکس / مصرف (Analytics / Usage / Metrics Service)

### ماموریت سرویس
جمع‌آوری و نگهداری رویدادهای استفاده (usage events) برای تحلیل محصول، گزارش استفاده، و حتی بیلینگ بر اساس مصرف.

### داده‌هایی که مالک آن است
- رخدادها مثل: `LOGIN`, `CREATED_TASK`, `UPLOADED_FILE`, ...
- آمار تجمیعی روزانه/ماهانه برای هر سازمان یا کاربر (DAU / MAU / مصرف منابع)

### قابلیت‌های ضروری
- API برای ثبت event از سرویس‌های دیگر
- API برای گرفتن آمار مصرف جهت:
  - داشبورد ادمین
  - محدودیت پلن (rate limit / quota)

### نکته
در فاز خیلی اولیه می‌تونی این رو با Audit یکی نگه داری.  
وقتی به data analytics، گزارش مدیریتی و محدودیت مصرف نیاز داشتی، جدا کن.

---

## ۹. سرویس جستجو (Search / Indexing Service)

### ماموریت سرویس
جستجوی فول‌تکست و فیلتر پیشرفته روی داده‌های دامنه اصلی (پروژه‌ها، تسک‌ها، پیام‌ها، داک‌ها و ...).

### داده‌هایی که مالک آن است
- ایندکس‌ آستین‌کج (Elasticsearch / Meilisearch / ...).  
  این سرویس «منبع حقیقت» اصلی نیست، فقط یک کپی قابل‌جستجو نگه می‌دارد.

### قابلیت‌های ضروری
- `POST /reindex` برای یک موجودیت
- `GET /search?q=...&filters=...`
- جداسازی tenant / سازمان در نتایج

### چرا جداست؟
الگوریتم سرچ مرتباً بهبود می‌خورد، و دوست نداری این تغییرات داخل سرویس دامنه اصلی و بیزنس‌لول لاجیک قاطی شود.

---

## ۱۰. سرویس دامنه اصلی (Domain Service)

> این تنها سرویسیه که وابسته به نوع محصول توست.

نمونه‌ها:
- اگر اپ مدیریت پروژه می‌سازی → سرویس «پروژه / تسک»
- اگر مارکت‌پلیس می‌سازی → سرویس «کاتالوگ محصول / سفارش»
- اگر سوشال می‌سازی → سرویس «پست / کامنت»
- اگر چت می‌سازی → سرویس «گفتگو / پیام»

### وظیفه‌اش
- نگهداری موجودیت‌های اصلی کسب‌وکار
- پیاده‌سازی قوانینی مثل "وقتی پروژه ساخته شد، کاربر سازنده owner است"
- ارسال رویداد برای بقیه سرویس‌ها (برای نوتیفیکیشن، بیلینگ، لاگ و ...)

### مهم
این سرویس نباید مستقیم ایمیل بفرستد  
نباید مستقیم پول بگیرد  
نباید فایل ذخیره کند  
همیشه باید فقط رویداد منتشر کند یا API سرویس‌های دیگر را صدا بزند.

---

## ۱۱. گیت‌وی / سرویس لبۀ API (API Gateway / Edge Service)

### ماموریت سرویس
نقطه ورودی واحد برای فرانت‌اند (وب / موبایل / کلاینت بیرونی).  
این سرویس درخواست را اعتبارسنجی می‌کند و بعد به سرویس داخلی درست فوروارد می‌کند.

### قابلیت‌های ضروری
- اعتبارسنجی توکن (با Auth)
- rate limiting
- ثبت لاگ درخواست‌ها
- مسیردهی درخواست‌ها به سرویس‌های داخلی
- اینجکت کردن شناسه کاربر و سازمان (تا سرویس‌های داخلی مجبور نباشند هر بار JWT رو دوباره باز کنند)

### چرا مهم است؟
- معماری داخلی‌ات را پشت یک API پایدار مخفی می‌کنی
- می‌توانی نسخه‌دهی API داشته باشی
- می‌توانی سرویس‌های داخلی را ریفکتور کنی بدون اینکه کلاینت بشکند

---

## اولویت ساخت (Roadmap پیشنهادی)

### فاز ۱ (MVP قابل لانچ)
۱. سرویس احراز هویت  
۲. سرویس پروفایل  
۳. سرویس فایل  
۴. سرویس نوتیفیکیشن (حداقل ایمیل)  
۵. سرویس دامنه اصلی (مثلاً ProjectService)  
۶. گیت‌وی / API Gateway

این شش‌تا عملاً تو را به یک محصول واقعی قابل استفاده می‌رسانند.

### فاز ۲ (وقتی تیم/سازمان/پول وارد ماجرا شد)
۷. سرویس بیلینگ  
۸. سرویس لاگ فعالیت (Audit)  
۹. سرویس دسترسی پیشرفته (Permissions)

### فاز ۳ (وقتی مقیاس و دیتا مهم شد)
۱۰. سرویس آنالیتیکس / مصرف  
۱۱. سرویس جستجو

---

## مرزبندی دیتابیس‌ها (Data Ownership)

هر سرویس دیتابیس خودش را دارد. مثال:

### Auth DB
- `users(id, email, password_hash, is_active, created_at)`
- `sessions(user_id, refresh_token, expires_at)`
- `memberships(user_id, org_id, role)`

### Profile DB
- `user_profiles(user_id -> users.id, display_name, bio, avatar_file_id, timezone, marketing_opt_in)`

### File DB
- `files(id, owner_user_id, org_id, storage_path, mime_type, size_bytes, visibility, created_at)`

### Notification DB
- `notifications(id, user_id, channel, template_key, payload_json, sent_at, read_at)`

### Billing DB
- `orgs(id, name, owner_user_id)`
- `subscriptions(org_id, plan, status, renews_at, canceled_at)`
- `invoices(id, org_id, amount_cents, status, issued_at, paid_at)`

ایده مهم:  
هیچ سرویس دیگری نباید مستقیم این جداول را بنویسد.  
بقیه فقط از طریق API رسمی همین سرویس با آن کار می‌کنند.

---

## معماری پیشنهادی کد

- مونو‌ریپو
- هر سرویس → یک پکیج/اپ جدا با دیتابیس جدا
- کتابخانه‌های مشترک:
  - DTOها و قراردادهای تایپ‌شده برای درخواست/پاسخ
  - تعریف event schema
  - middleware لاگینگ / correlation-id / tracing

### ارتباط سرویس‌ها
- Sync (HTTP/gRPC) برای درخواست مستقیم
- Async (پیام/Queue) برای رویدادها مثل:
  - `USER_CREATED`
  - `FILE_UPLOADED`
  - `INVOICE_PAID`

---

## جمع‌بندی سریع

سرویس‌هایی که باید همیشه در جعبه ابزار قابل‌تکرار داشته باشی:

1. سرویس احراز هویت (Auth)
2. سرویس پروفایل کاربر (Profile)
3. سرویس نوتیفیکیشن (Notification)
4. سرویس فایل / رسانه (File)
5. سرویس بیلینگ و پرداخت (Billing)
6. سرویس لاگ فعالیت (Audit)
7. سرویس دسترسی و مجوزها (Permissions)
8. سرویس آنالیتیکس / مصرف (Analytics / Usage)
9. سرویس جستجو (Search)
10. گیت‌وی API (API Gateway)
11. سرویس دامنه اصلی (Domain Service) ← متغیر براساس نوع محصول

الگوی طلایی:
- همه سرویس‌های پشتیبان (Auth, File, Billing, ...) رو یک‌بار می‌سازی و نگه می‌داری
- در هر پروژهٔ جدید فقط سرویس دامنه اصلی رو عوض می‌کنی

</div>
